<!DOCTYPE html>
<html>
  <head>
    <title>WebSocket Test</title>
    <link rel="icon" href="data:," />
    <script>
      class MockWebSocket {
        constructor(url) {
          this.url = url;
          this.readyState = 0;

          console.log(`MockWebSocket: Attempting to connect to ${url}`);

          // Simulate connection behavior
          setTimeout(() => {
            try {
              const { hostname } = new URL(url);
              if (hostname === 'blocked.example.com') {
                window.location.href = `http://localhost:9999/#hostname=${url}&href=${encodeURIComponent(
                  url,
                )}`;
              } else {
                this.readyState = 1; // OPEN
                if (this.onopen) {
                  this.onopen();
                }
              }
            } catch (error) {
              console.error('Invalid URL:', url);
            }
          }, 100);
        }

        send(message) {
          if (this.readyState !== 1) {
            throw new Error('WebSocket is not open');
          }
          console.log(`MockWebSocket: Sent message: ${message}`);
          setTimeout(() => {
            if (this.onmessage) {
              this.onmessage({ data: `Echo: ${message}` });
            }
          }, 50);
        }

        close() {
          this.readyState = 3;
          if (this.onclose) {
            this.onclose();
          }
          console.log('MockWebSocket: Connection closed');
        }
      }

      window.WebSocket = MockWebSocket;

      function testWebSocketConnection(url) {
        try {
          const socket = new WebSocket(url);
          socket.onopen = () => {
            console.log('WebSocket connection opened');
            socket.send('Hello, server!');
          };
          socket.onerror = (error) => {
            console.error('WebSocket error:', error.message);
          };
          socket.onmessage = (event) => {
            console.log('Message received:', event.data);
          };
          socket.onclose = () => {
            console.log('WebSocket connection closed');
          };
        } catch (error) {
          console.error('WebSocket creation failed:', error);
        }
      }

      testWebSocketConnection('wss://blocked.example.com');
    </script>
  </head>
  <body>
    <h1>Mock Malicious WebSocket Test</h1>
  </body>
</html>
