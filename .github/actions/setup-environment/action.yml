name: Setup environment
description: Setup environment
inputs:
  should-checkout:
    required: false
    default: 'true'
  should-cache:
    required: false
    default: 'true'
runs:
  using: composite
  steps:
    - name: Checkout repository
      if: ${{ inputs.should-checkout == 'true' }}
      uses: actions/checkout@v4

    - name: printout
      if: ${{ inputs.should-checkout == 'false' }}
      run: echo ${{ job.container }}
      shell: bash

    # actions/cache/restore will not work in a container unless zstd is installed
    - name: Install zstd
      if: ${{ inputs.should-checkout == 'false' }}
      run: sudo apt-get update && sudo apt-get install zstd
      shell: bash

    - name: Download workspace
      if: ${{ inputs.should-checkout == 'false' }}
      uses: actions/cache/restore@v4
      with:
        path: ./
        key: workspace-${{ github.sha }}

    - run: corepack enable
      shell: bash

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version-file: .nvmrc
        cache: yarn
        cache-dependency-path: yarn.lock

    - name: Install dependencies
      if: ${{ inputs.should-checkout == 'true' }}
      run: yarn --immutable
      shell: bash

    - name: Cache workspace
      if: ${{ inputs.should-cache == 'true'}}
      uses: actions/cache/save@v4
      with:
        path: ./
        key: workspace-${{ github.sha }}
