name: 'Benchmarks'

on:
  push:
    branches: self-hosted-temp
  repository_dispatch:
    types: [start-example-workflow]
  workflow_dispatch:
    inputs:
      name:
        description: 'name'
      home:
        description: 'home'
jobs:
  test:
    name: Benchmark
    runs-on: ubuntu-latest
    # container: cimg/node:20.18-browsers
    # runs-on: [self-hosted, Linux, X64]
    container:
      image: selenium/standalone-chrome:126.0
      options: --user root
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Debugging with tmate
        uses: ./.github/actions/actions-tmate

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: yarn
          cache-dependency-path: yarn.lock

      - run: corepack enable
        shell: bash

      - name: Install dependencies
        run: yarn
        shell: bash

      # - run: yarn build:test
      - run: yarn webpack --test

      - name: Install prereqs
        run: |
          apt-get update
          apt-get install -y xvfb
          apt-get -y install xorg xvfb gtk2-engines-pixbuf
          apt-get -y install dbus-x11 xfonts-base xfonts-100dpi xfonts-75dpi xfonts-cyrillic xfonts-scalable
          Xvfb -ac :99 -screen 0 1280x1024x16 &
          export DISPLAY=:99

      - name: Run the benchmark
        run: yarn benchmark:chrome --out test-artifacts/chrome/benchmark/pageload.json --retries 2

      - name: 'Upload Artifact'
        uses: actions/upload-artifact@v4
        with:
          name: pageload
          path: test-artifacts/chrome/benchmark/pageload.json
          retention-days: 5
